# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=portfile:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           compiler_blacklist_versions 1.0

name                rust
version             0.5
revision            3
categories          lang devel
platforms           darwin
supported_archs     i386 x86_64
# https://github.com/mozilla/rust/issues/2024
universal_variant   no
license             {MIT Apache-2} BSD zlib NCSA Permissive
maintainers         g5pw larryv

description         Compiler for the Rust programming language
long_description    This is a compiler for Rust, including standard \
                    libraries, tools and documentation.
homepage            http://www.rust-lang.org


# stage0 snapshot compiler, see src/snapshots.txt in main distribution
set stage0(date)            2012-12-19
set stage0(rev)             8554d5e
set stage0(platform)        macos-${configure.build_arch}
switch ${configure.build_arch} {
    i386 {
        set stage0(hash)    151ff211c01f0b7a1895b93ff0bc021bf1472346
        set stage0(rmd160)  300b17458073a8704817821bd5406189a264f765
        set stage0(sha256)  5e598d4c45ee2dd8b7f2b69d92f60d16e57991e796d76ca255a612357a5e48e0
    }
    x86_64 {
        set stage0(hash)    e4564933f11b17f7dbd25b61032233693da21dc5
        set stage0(rmd160)  3d966bd2d17e3f2c74ed78f3674439c89d5a16ee
        set stage0(sha256)  a2e287a683128e2e213e11c5b9f92e5e628eb63163591d61523549deb2e21f7d
    }
}
set stage0(distfile)        [join "rust stage0 ${stage0(date)} ${stage0(rev)}
                                ${stage0(platform)} ${stage0(hash)}" -].tar.bz2
set stage0(distdir)         rust-stage0


master_sites        http://dl.rust-lang.org/dist:dist \
                    http://static.rust-lang.org/stage0-snapshots:stage0
distfiles           ${distname}${extract.suffix}:dist \
                    ${stage0(distfile)}:stage0
checksums           ${distname}${extract.suffix} \
                        rmd160  b4988da7be984aa1337f4076e96e6d0c72e3170d \
                        sha256  d326d22707f0562d669c11efbc33ae812ddbf76ab78f07087fc5beb095a8928a \
                    ${stage0(distfile)} \
                        rmd160  ${stage0(rmd160)} \
                        sha256  ${stage0(sha256)}

depends_extract     bin:bzip2:bzip2
extract.only-delete ${stage0(distfile)}
post-extract {
    set expand "bzip2 -dc ${distpath}/${stage0(distfile)}"
    set untar "${portutil::autoconf::tar_command} -xf -"
    system -W ${workpath} "${expand} | ${untar}"
}

patchfiles          patch-configure.diff \
                    patch-src-etc-local_stage0.sh.diff \
                    patch-src-librusti-rusti.rc.diff \
                    patch-src-rustllvm-RustWrapper.cpp.diff
post-patch {
    reinplace "s/__BUILD_ARCH__/${configure.build_arch}/g" \
        ${worksrcpath}/configure
}

# Required until we figure out how to use MacPorts' LLVM instead of the
# bundled one. Using MacPorts' LLVM currently results in a stage2
# compiler that segfaults during the build (with llvm-3.2, at least).
depends_build       bin:python2.7:python27

# Upstream only supports gcc 4.4 and newer and clang based on LLVM
# 3.0svn and newer. The allowed clang build could probably be tightened.
compiler.blacklist  gcc-3.3 gcc-4.0 gcc-4.2 \
                    apple-gcc-4.0 apple-gcc-4.2 \
                    llvm-gcc-4.2 macports-llvm-gcc-4.2 \
                    macports-gcc-4.2 macports-gcc-4.3 \
                    {clang <= 77} macports-clang-2.9
# TODO: Remove when base fallback lists are updated (2.2?).
compiler.fallback-append            macports-clang-3.2
if {${configure.compiler} == "macports-clang-3.2"} {
    depends_build-append            port:clang-3.2
    depends_skip_archcheck-append   clang-3.2
}

configure.args      --disable-docs \
                    --enable-local-rust \
                    --local-rust-root=${workpath}/${stage0(distdir)}
if {[string match *clang* ${configure.compiler}]} {
    configure.args-append   --enable-clang
}

build.type          gnu
build.args          VERBOSE=1 \
                    CC=${configure.cc} \
                    CXX=${configure.cxx} \
                    CPP="${configure.cc} -E"

test.run            yes
test.target         check
test.env            VERBOSE=1

destroot.args       VERBOSE=1

livecheck.type      regex
livecheck.url       ${homepage}
livecheck.regex     {/release-(\d\.\d)/}
