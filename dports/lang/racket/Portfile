# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                racket
version             5.3.2
categories          lang
platforms           darwin
maintainers         larryv

license             LGPL-2.1
description         Racket is a programming language.
long_description    {Depending on how you look at it, Racket is\
                    a programming language — a dialect of Lisp and\
                    a descendant of Scheme; a family of programming\
                    languages — variants of Racket, and more; or a set\
                    of tools — for using a family of programming languages.}
homepage            http://racket-lang.org/

master_sites        http://download.racket-lang.org/installers/${version}/racket/ \
                    http://www.eecs.northwestern.edu/racket/${version}/racket/ \
                    http://www.cs.utah.edu/plt/installers/${version}/racket/ \
                    http://mirror.csclub.uwaterloo.ca/racket/racket-installers/${version}/racket/ \
                    http://mirror.informatik.uni-tuebingen.de/mirror/racket/${version}/racket/ \
                    http://racket.infogroep.be/${version}/racket/
distname            racket-${version}-src-mac
use_dmg             yes
checksums           rmd160  04816f86365ecfa9752588638d7b540bf6867d90 \
                    sha256  0ab99f586407c476761d6014fa38c1f75eb7965e838b4ff2ace54a25bf42856c

depends_lib         port:jpeg \
                    port:libpng \
                    port:libiconv

worksrcdir          "${distname}/Racket v${version} Source/src"

patchfiles          patch-configure.diff \
                    patch-collects-setup-unixstyle-install.ss.diff \
                    patch-mzscheme-Makefile.in.diff
patch.dir           ${workpath}/mz-${version}

post-patch {
    reinplace "s|collects|share/mzscheme|g" \
        ${worksrcpath}/mzscheme/src/startup.ss \
        ${worksrcpath}/mzscheme/src/startup.inc
    reinplace "s|~/Library/PLT Scheme/|${prefix}/share/mzscheme/|g" \
        ${worksrcpath}/mzscheme/src/file.c
    reinplace "s|@FRAMEWORK_INSTALL_DIR@|${destroot}${frameworks_dir}|" \
        ${worksrcpath}/mzscheme/Makefile.in
    reinplace "s|-I\$(srcdir)|-iquote \$(srcdir)|g" \
        ${worksrcpath}/foreign/gcc/libffi/include/Makefile.in \
        ${worksrcpath}/foreign/gcc/libffi/Makefile.in \
        ${worksrcpath}/foreign/Makefile.in \
        ${worksrcpath}/Makefile.in \
        ${worksrcpath}/mzscheme/dynsrc/Makefile.in \
        ${worksrcpath}/mzscheme/gc/doc/Makefile.in \
        ${worksrcpath}/mzscheme/gc/include/Makefile.in \
        ${worksrcpath}/mzscheme/gc/Makefile.in \
        ${worksrcpath}/mzscheme/gc2/Makefile.in \
        ${worksrcpath}/mzscheme/Makefile.in \
        ${worksrcpath}/mzscheme/sgc/Makefile.in \
        ${worksrcpath}/mzscheme/src/Makefile.in    
}

configure.args      --enable-libfw

post-destroot {
    ln -s ${frameworks_dir}/PLT_MzScheme.framework/Versions/${version}/PLT_MzScheme \
        ${destroot}${prefix}/lib/libmzscheme.${version}.dylib

    system "/usr/bin/install_name_tool -change\
        PLT_MzScheme.framework/Versions/${version}_3m/PLT_MzScheme\
        ${frameworks_dir}/PLT_MzScheme.framework/Versions/${version}_3m/PLT_MzScheme\
        ${destroot}${prefix}/bin/mzscheme"
}

livecheck.type      regex
livecheck.url       http://download.plt-scheme.org/mzscheme/
livecheck.regex     {<b>([0-9.]+)</b>}
